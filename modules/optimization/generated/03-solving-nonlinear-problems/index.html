<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="This site is about foldable robotics.
">
  <meta name="author" content="Daniel M. Aukes">
  <meta name="generator" content="Jekyll v4.1.1">
  <title>Solving Nonlinear Problems with Scipy Optimize and pyCMA | Foldable Robotics </title>

  <!--<link rel="canonical" href="https://getbootstrap.com/docs/4.5/examples/blog/">-->
  
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&display=swap" rel="stylesheet"> 
  <link href="https://fonts.googleapis.com/css2?family=Oleo+Script:wght@400;700&display=swap" rel="stylesheet"> 
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet"> 
  
  <!-- Bootstrap core CSS -->
  <link href="/assets/bootstrap-4.5.3-dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>
  
  <!-- Custom styles for this template -->
  <link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
  <!-- Custom styles for this template -->

  <link href="/assets/blog.css" rel="stylesheet">
  <link href="/assets/fontawesome-free-5.15.1-web/css/all.css" rel="stylesheet"> <!--load all styles -->
  
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/favicon/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/favicon/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/favicon/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/favicon/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/favicon/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/favicon/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/favicon/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/favicon/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/favicon/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/favicon/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
  <link rel="manifest" href="/assets/favicon/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/favicon/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
</head>
<body>
<div class="container">      
<header class="blog-header py-3">
  <div class="row flex-nowrap justify-content-between align-items-center">
    <div class="col-2 pt-1">
      
    </div>
    <div class="col-8 text-center">
      <a class="blog-header-logo text-dark" href="/">Foldable Robotics</a>
    </div>
    <div class="col-2 d-flex justify-content-end align-items-center">

    </div>
  </div>
</header>


<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <a class="navbar-brand" href="/">Home</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Modules
        </a>
        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
          
          <a class="dropdown-item" href="/modules/introduction">Introduction</a>
          
          <a class="dropdown-item" href="/modules/biomechanics">Biomechanics</a>
          
          <a class="dropdown-item" href="/modules/kinematics">Kinematics</a>
          
          <a class="dropdown-item" href="/modules/compliance">Mechanics and Compliance</a>
          
          <a class="dropdown-item" href="/modules/dynamics">Dynamics</a>
          
          <a class="dropdown-item" href="/modules/optimization">Optimization</a>
          
          <a class="dropdown-item" href="/modules/manufacturing">Prototyping & Manufacturing</a>
          
          <a class="dropdown-item" href="/modules/integration">Integration</a>
          
          <a class="dropdown-item" href="/modules/validation">Experimental Validation</a>
          
          <a class="dropdown-item" href="/modules/project">Project</a>
          
          <a class="dropdown-item" href="/modules/python">Python</a>
          
          <a class="dropdown-item" href="/modules/misc">Misc</a>
          
        </div>
      </li>
      
      <li class="nav-item">
      
      <a class="nav-link" href="/class_schedule">Class Schedule</a>
      

      </li>
      
      <li class="nav-item">
      
      <a class="nav-link" href="/my-assignments">Assignments</a>
      

      </li>
      
      <li class="nav-item">
      
      <a class="nav-link" href="/my-tutorials">Tutorials</a>
      

      </li>
      
      <li class="nav-item">
      
      <a class="nav-link" href="https://canvas.asu.edu/calendar#view_name=month" target="_blank">Canvas Calendar <i class="fas fa-external-link-alt"></i></i></a>
      

      </li>
      
      <li class="nav-item">
      
      <a class="nav-link" href="https://canvas.asu.edu/courses/71725" target="_blank">Canvas <i class="fas fa-external-link-alt"></i></i></a>
      

      </li>
      
  </div>
</nav>
<div class="row">
<div class="col-md-4 text-center">
  
  
      <h5>
        Module: <a href="/modules/optimization">optimization</a>
      </h5>
  
  
</div>
<div class="col-md-4 text-center">
  
  
      <h4>
        Solving Nonlinear Problems with Scipy Optimize and pyCMA
      </h4>
  
  
</div>
<div class="col-md-4 text-center">
  
</div>
</div>
</div><!-- /.row -->
<main role="main" class="container">
  <h1 id="solving-nonlinear-problems-with-scipy-optimize-and-pycma">Solving Nonlinear Problems with Scipy Optimize and pyCMA</h1>
<h2 id="introduction">Introduction</h2>
<p>Nonlinear solvers can suffer from the possibility of reaching local minima if the initial guess is too far away from the best minimum solution. This is especially true when trying to fit nonlinear functions. This example contrasts the difference between the scipy optimize function and the pyCMA package.</p>
<p>The pyCMA package provides python with an implementation of the “covariance matrix adaptation evolutionary strategy” (wikipedia page <a href="https://en.wikipedia.org/wiki/CMA-ES">here</a>). You can install the pycma package from the command line by executing <code>pip install cma</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span></code></pre></div>
<p>Import all necessary packages</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.optimize</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy.random</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cma</span></code></pre></div>
<p>create a function for plotting solutions against the input data</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_params(parameters):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    w,w0 <span class="op">=</span> parameters</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    y_model <span class="op">=</span> numpy.sin(w<span class="op">*</span>x<span class="op">-</span>w0)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> plt.plot(x,y_model,<span class="st">&#39;r-.&#39;</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> plt.plot(x,y_data,<span class="st">&#39;bo&#39;</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> p</span></code></pre></div>
<p>create the x array</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> numpy.r_[<span class="op">-</span><span class="dv">10</span>:<span class="dv">10</span>:<span class="fl">.1</span>]</span></code></pre></div>
<p>define your model parameters</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>parameters <span class="op">=</span> (<span class="fl">2.1</span>,<span class="fl">.24</span>)</span></code></pre></div>
<p>split model parameters into frequency and frequency offset</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>w,w0 <span class="op">=</span> parameters</span></code></pre></div>
<p>Build the original model as a sine function. This is ideal because you can reach many local minima as a function of <span class="math inline">\(\omega\)</span> and <span class="math inline">\(\omega_0\)</span></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> numpy.sin(w<span class="op">*</span>x<span class="op">-</span>w0)</span></code></pre></div>
<p>Add some random noise</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>rand <span class="op">=</span> numpy.random.randn(<span class="op">*</span>y.shape)<span class="op">/</span><span class="dv">10</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>y_data <span class="op">=</span> y<span class="op">+</span>rand</span></code></pre></div>
<p>And plot the model data with noise against the original model</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot()</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>a<span class="op">=</span>ax.plot(x,y,<span class="st">&#39;r&#39;</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>b<span class="op">=</span>ax.plot(x,y_data,<span class="st">&#39;bo&#39;</span>)</span></code></pre></div>
<figure>
<img src="output_17_0.png" alt="png" /><figcaption aria-hidden="true">png</figcaption>
</figure>
<p>Now create a function that returns the sum of squared error between a model guess and the original model data</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> myfunc(parameters):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    w,w0 <span class="op">=</span> parameters</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    y_model <span class="op">=</span> numpy.sin(w<span class="op">*</span>x<span class="op">-</span>w0)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    error <span class="op">=</span> ((y_model<span class="op">-</span>y_data)<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>()</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> error</span></code></pre></div>
<p>Now find out the error of the actual model against its own noise;</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>myfunc([<span class="fl">2.1</span>,<span class="fl">.24</span>])</span></code></pre></div>
<pre><code>2.3855951073161688</code></pre>
<p>Now define an initial guess for the solver to try to find the parameters itself</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>ini <span class="op">=</span> [<span class="dv">1</span>,<span class="dv">1</span>]</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>sol <span class="op">=</span> scipy.optimize.minimize(myfunc,ini)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>sol.fun</span></code></pre></div>
<pre><code>190.07064566371594</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>plot_params(sol.x)</span></code></pre></div>
<pre><code>[&lt;matplotlib.lines.Line2D at 0x2048cf2e5e0&gt;]</code></pre>
<figure>
<img src="output_25_1.png" alt="png" /><figcaption aria-hidden="true">png</figcaption>
</figure>
<p>Now rerun with a much closer initial guess</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>ini <span class="op">=</span> [<span class="dv">2</span>,<span class="dv">1</span>]</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>sol <span class="op">=</span> scipy.optimize.minimize(myfunc,ini)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sol.fun)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>plot_params(sol.x)</span></code></pre></div>
<pre><code>2.3560305442401464





[&lt;matplotlib.lines.Line2D at 0x2048cf8f970&gt;]</code></pre>
<figure>
<img src="output_27_2.png" alt="png" /><figcaption aria-hidden="true">png</figcaption>
</figure>
<h2 id="cma-example">CMA example</h2>
<p>Now we’re going to try with pyCMA and the original initial guess</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>ini <span class="op">=</span> [<span class="dv">1</span>,<span class="dv">1</span>]</span></code></pre></div>
<p>Run the optimization and display the results at the end.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>es <span class="op">=</span> cma.CMAEvolutionStrategy(ini, <span class="fl">0.5</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>es.logger.disp_header()</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="kw">not</span> es.stop():</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>      X <span class="op">=</span> es.ask()</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>      es.tell(X, [myfunc(x) <span class="cf">for</span> x <span class="kw">in</span> X])</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>      es.logger.add()</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>es.logger.disp([<span class="op">-</span><span class="dv">1</span>])</span></code></pre></div>
<pre><code>(3_w,6)-aCMA-ES (mu_w=2.0,w_1=63%) in dimension 2 (seed=160127, Wed Dec 16 11:11:28 2020)
Iterat Nfevals  function value    axis ratio maxstd  minstd
   89    534 2.35603054423994e+00 4.1e+00 8.97e-10 2.46e-10</code></pre>
<p>Plot the convergence of the CMA-ES algorithm</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>es.logger.plot()</span></code></pre></div>
<pre><code>C:\Anaconda3\lib\site-packages\cma\logger.py:874: MatplotlibDeprecationWarning: The global colormaps dictionary is no longer considered public API.
  color = iter(pyplot.cm.cmap_d[&#39;plasma_r&#39;](np.linspace(0.35, 1,





&lt;cma.logger.CMADataLogger at 0x2048cfc3d30&gt;</code></pre>
<figure>
<img src="output_33_2.png" alt="png" /><figcaption aria-hidden="true">png</figcaption>
</figure>
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>es.best.x</span></code></pre></div>
<pre><code>array([2.09823899, 0.25389465])</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>myfunc(es.best.x)</span></code></pre></div>
<pre><code>2.3560305442399363</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>plot_params(es.best.x)</span></code></pre></div>
<pre><code>[&lt;matplotlib.lines.Line2D at 0x2048e4938e0&gt;]</code></pre>
<figure>
<img src="output_36_1.png" alt="png" /><figcaption aria-hidden="true">png</figcaption>
</figure>
<p>If you re-run this optimization, even with the same initial guess, there is no guarantee of convergence, especially when your initial guess is far away from the actual value. This is because the success of the algorithm, as well as its ability to reach beyond local minima, is based on injecting randomness into each evolution of the algorithm. This means that each optimization will produce slightly different results in a different number of steps. This must be traded off for the ability to escape local minima.</p>

</main><!-- /.container -->
<footer class="blog-footer">
  

  <p>Copyright &copy; 2021 Daniel M. Aukes.  All rights reserved.</p>
  <p><a href="#">Back to top</a></p>
</footer>

<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</body>
</html>
