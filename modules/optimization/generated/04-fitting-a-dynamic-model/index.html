<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <title>
Fitting a Dynamic Model | Foldable Robotics
</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">

<style>
  .bd-placeholder-img {
    font-size: 1.125rem;
    text-anchor: middle;
    -webkit-user-select: none;
    -moz-user-select: none;
    user-select: none;
  }

  @media (min-width: 768px) {
    .bd-placeholder-img-lg {
      font-size: 3.5rem;
    }
  }
</style>

<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Oleo+Script:wght@400;700&display=swap" rel="stylesheet"> 
<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet"> 


<link href="/css/blog.css" rel="stylesheet">
<link href="/css/features.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">


    <script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$','$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };

  window.addEventListener('load', (event) => {
      document.querySelectorAll("mjx-container").forEach(function(x){
        x.parentElement.classList += 'has-jax'})
    });

</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <link rel="stylesheet" type="text/css" href="/hugo-cite.css" />

    <link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/favicon/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
<link rel="manifest" href="/favicon/manifest.json">


  </head>
  <body>

    <div class="container">

      <header class="blog-header py-3">
  <div class="row flex-nowrap justify-content-between align-items-center">
    <div class="col-2 pt-1">
    </div>
    <div class="col-8 text-center">
      <a class="blog-header-logo text-dark" href="/">Foldable Robotics</a>
    </div>
    <div class="col-2 d-flex justify-content-end align-items-center">
    </div>
  </div>
</header>


      <nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">Home</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        
        
        
        
        
      
        <li class="nav-item">
          <a class="nav-link" href="/assignments/">Assignments</a>
        </li>
        
        
        
        
        
      
        <li class="nav-item">
          <a class="nav-link" href="/calendar/">Course Calendar</a>
        </li>
        
        
        
        
        
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="/course-documents/" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Course Documents
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
            
            <li><a class="dropdown-item" href="/course-documents/software-list/">Software List</a></li>
            
            <li><a class="dropdown-item" href="/course-documents/submission-best-practices/">Submission Best Practices</a></li>
            
            <li><a class="dropdown-item" href="/course-documents/suggested-materials-list/">Suggested Materials List</a></li>
            
            <li><a class="dropdown-item" href="/course-documents/syllabus-web/">Syllabus for Foldable Robotics</a></li>
            
          </ul>
        </li>
        
        
        
        
        
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="/modules/" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Course Topics
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
            
            <li><a class="dropdown-item" href="/modules/biomechanics/">Biomechanics &amp; Bio-inspiration</a></li>
            
            <li><a class="dropdown-item" href="/modules/dynamics/">Dynamics</a></li>
            
            <li><a class="dropdown-item" href="/modules/validation/">Experimental Validation</a></li>
            
            <li><a class="dropdown-item" href="/modules/integration/">Integration</a></li>
            
            <li><a class="dropdown-item" href="/modules/introduction/">Introduction</a></li>
            
            <li><a class="dropdown-item" href="/modules/kinematics/">Kinematics</a></li>
            
            <li><a class="dropdown-item" href="/modules/compliance/">Mechanics and Compliance</a></li>
            
            <li><a class="dropdown-item" href="/modules/misc/">Misc</a></li>
            
            <li><a class="dropdown-item" href="/modules/optimization/">Optimization</a></li>
            
            <li><a class="dropdown-item" href="/modules/project/">Project</a></li>
            
            <li><a class="dropdown-item" href="/modules/manufacturing/">Prototyping &amp; Manufacturing</a></li>
            
            <li><a class="dropdown-item" href="/modules/python/">Python</a></li>
            
          </ul>
        </li>
        
        
        
        
        
      
        <li class="nav-item">
          <a class="nav-link" href="/lectures/">Lectures</a>
        </li>
        
        
        
        
        <li class="nav-item">
          
          <a class="nav-link" href="https://canvas.asu.edu/"target="_blank">Canvas <i class="bi bi-link"></i></a> 
        </li>
        
        
      </ul>
      <span class="navbar-text">
        Making better Foldable Robots
      </span>

    </div>
  </div>
</nav>

    </div>

    
<main class="container">
  <article>
  <h1 id="fitting-a-dynamic-model">Fitting a Dynamic Model</h1>
<h2 id="introduction">Introduction</h2>
<p>This example takes us through the beginning of the triple pendulum example again.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># -*- coding: utf-8 -*-</span>

<span style="color:#f92672">import</span> pynamics
<span style="color:#f92672">from</span> pynamics.frame <span style="color:#f92672">import</span> Frame
<span style="color:#f92672">from</span> pynamics.variable_types <span style="color:#f92672">import</span> Differentiable,Constant
<span style="color:#f92672">from</span> pynamics.system <span style="color:#f92672">import</span> System
<span style="color:#f92672">from</span> pynamics.body <span style="color:#f92672">import</span> Body
<span style="color:#f92672">from</span> pynamics.dyadic <span style="color:#f92672">import</span> Dyadic
<span style="color:#f92672">from</span> pynamics.output <span style="color:#f92672">import</span> Output,PointsOutput
<span style="color:#f92672">from</span> pynamics.particle <span style="color:#f92672">import</span> Particle
<span style="color:#f92672">import</span> pynamics.integration
<span style="color:#f92672">import</span> numpy
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
plt<span style="color:#f92672">.</span>ion()
<span style="color:#f92672">from</span> math <span style="color:#f92672">import</span> pi
</code></pre></div><p>We need to import some additional libraries for optimization and interpolation</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> logging
<span style="color:#f92672">import</span> pynamics.integration
<span style="color:#f92672">import</span> pynamics.system
<span style="color:#f92672">import</span> numpy.random
<span style="color:#f92672">import</span> scipy.interpolate
<span style="color:#f92672">import</span> scipy.optimize
<span style="color:#f92672">import</span> cma
</code></pre></div><p>The rest of this code proceeds as in the triple pendulum example&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">system <span style="color:#f92672">=</span> System()
pynamics<span style="color:#f92672">.</span>set_system(__name__,system)

lA <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;lA&#39;</span>,system)
lB <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;lB&#39;</span>,system)
lC <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;lC&#39;</span>,system)

mA <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;mA&#39;</span>,system)
mB <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;mB&#39;</span>,system)
mC <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;mC&#39;</span>,system)

g <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">9.81</span>,<span style="color:#e6db74">&#39;g&#39;</span>,system)
b <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1e1</span>,<span style="color:#e6db74">&#39;b&#39;</span>,system)
k <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1e1</span>,<span style="color:#e6db74">&#39;k&#39;</span>,system)

preload1 <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">0</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">180</span>,<span style="color:#e6db74">&#39;preload1&#39;</span>,system)
preload2 <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">0</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">180</span>,<span style="color:#e6db74">&#39;preload2&#39;</span>,system)
preload3 <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">0</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">180</span>,<span style="color:#e6db74">&#39;preload3&#39;</span>,system)

Ixx_A <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;Ixx_A&#39;</span>,system)
Iyy_A <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;Iyy_A&#39;</span>,system)
Izz_A <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;Izz_A&#39;</span>,system)
Ixx_B <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;Ixx_B&#39;</span>,system)
Iyy_B <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;Iyy_B&#39;</span>,system)
Izz_B <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;Izz_B&#39;</span>,system)
Ixx_C <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;Ixx_C&#39;</span>,system)
Iyy_C <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;Iyy_C&#39;</span>,system)
Izz_C <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;Izz_C&#39;</span>,system)

tol <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-12</span>

tinitial <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
tfinal <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
fps <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>
tstep <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>fps
t <span style="color:#f92672">=</span> numpy<span style="color:#f92672">.</span>r_[tinitial:tfinal:tstep]

qA,qA_d,qA_dd <span style="color:#f92672">=</span> Differentiable(<span style="color:#e6db74">&#39;qA&#39;</span>,system)
qB,qB_d,qB_dd <span style="color:#f92672">=</span> Differentiable(<span style="color:#e6db74">&#39;qB&#39;</span>,system)
qC,qC_d,qC_dd <span style="color:#f92672">=</span> Differentiable(<span style="color:#e6db74">&#39;qC&#39;</span>,system)

initialvalues <span style="color:#f92672">=</span> {}
initialvalues[qA]<span style="color:#f92672">=-</span><span style="color:#ae81ff">45</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">180</span>
initialvalues[qA_d]<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">180</span>
initialvalues[qB]<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">180</span>
initialvalues[qB_d]<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">180</span>
initialvalues[qC]<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">180</span>
initialvalues[qC_d]<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">180</span>

statevariables <span style="color:#f92672">=</span> system<span style="color:#f92672">.</span>get_state_variables()
ini <span style="color:#f92672">=</span> [initialvalues[item] <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> statevariables]

N <span style="color:#f92672">=</span> Frame(<span style="color:#e6db74">&#39;N&#39;</span>)
A <span style="color:#f92672">=</span> Frame(<span style="color:#e6db74">&#39;A&#39;</span>)
B <span style="color:#f92672">=</span> Frame(<span style="color:#e6db74">&#39;B&#39;</span>)
C <span style="color:#f92672">=</span> Frame(<span style="color:#e6db74">&#39;C&#39;</span>)

system<span style="color:#f92672">.</span>set_newtonian(N)

A<span style="color:#f92672">.</span>rotate_fixed_axis_directed(N,[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>],qA,system)
B<span style="color:#f92672">.</span>rotate_fixed_axis_directed(A,[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>],qB,system)
C<span style="color:#f92672">.</span>rotate_fixed_axis_directed(B,[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>],qC,system)

pNA<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">*</span>N<span style="color:#f92672">.</span>x
pAB<span style="color:#f92672">=</span>pNA<span style="color:#f92672">+</span>lA<span style="color:#f92672">*</span>A<span style="color:#f92672">.</span>x
pBC <span style="color:#f92672">=</span> pAB <span style="color:#f92672">+</span> lB<span style="color:#f92672">*</span>B<span style="color:#f92672">.</span>x
pCtip <span style="color:#f92672">=</span> pBC <span style="color:#f92672">+</span> lC<span style="color:#f92672">*</span>C<span style="color:#f92672">.</span>x

pAcm<span style="color:#f92672">=</span>pNA<span style="color:#f92672">+</span>lA<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>A<span style="color:#f92672">.</span>x
pBcm<span style="color:#f92672">=</span>pAB<span style="color:#f92672">+</span>lB<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>B<span style="color:#f92672">.</span>x
pCcm<span style="color:#f92672">=</span>pBC<span style="color:#f92672">+</span>lC<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>C<span style="color:#f92672">.</span>x

wNA <span style="color:#f92672">=</span> N<span style="color:#f92672">.</span>getw_(A)
wAB <span style="color:#f92672">=</span> A<span style="color:#f92672">.</span>getw_(B)
wBC <span style="color:#f92672">=</span> B<span style="color:#f92672">.</span>getw_(C)

IA <span style="color:#f92672">=</span> Dyadic<span style="color:#f92672">.</span>build(A,Ixx_A,Iyy_A,Izz_A)
IB <span style="color:#f92672">=</span> Dyadic<span style="color:#f92672">.</span>build(B,Ixx_B,Iyy_B,Izz_B)
IC <span style="color:#f92672">=</span> Dyadic<span style="color:#f92672">.</span>build(C,Ixx_C,Iyy_C,Izz_C)

BodyA <span style="color:#f92672">=</span> Body(<span style="color:#e6db74">&#39;BodyA&#39;</span>,A,pAcm,mA,IA,system)
BodyB <span style="color:#f92672">=</span> Body(<span style="color:#e6db74">&#39;BodyB&#39;</span>,B,pBcm,mB,IB,system)
BodyC <span style="color:#f92672">=</span> Body(<span style="color:#e6db74">&#39;BodyC&#39;</span>,C,pCcm,mC,IC,system)

system<span style="color:#f92672">.</span>addforce(<span style="color:#f92672">-</span>b<span style="color:#f92672">*</span>wNA,wNA)
system<span style="color:#f92672">.</span>addforce(<span style="color:#f92672">-</span>b<span style="color:#f92672">*</span>wAB,wAB)
system<span style="color:#f92672">.</span>addforce(<span style="color:#f92672">-</span>b<span style="color:#f92672">*</span>wBC,wBC)

system<span style="color:#f92672">.</span>add_spring_force1(k,(qA<span style="color:#f92672">-</span>preload1)<span style="color:#f92672">*</span>N<span style="color:#f92672">.</span>z,wNA) 
system<span style="color:#f92672">.</span>add_spring_force1(k,(qB<span style="color:#f92672">-</span>preload2)<span style="color:#f92672">*</span>N<span style="color:#f92672">.</span>z,wAB)
system<span style="color:#f92672">.</span>add_spring_force1(k,(qC<span style="color:#f92672">-</span>preload3)<span style="color:#f92672">*</span>N<span style="color:#f92672">.</span>z,wBC)

system<span style="color:#f92672">.</span>addforcegravity(<span style="color:#f92672">-</span>g<span style="color:#f92672">*</span>N<span style="color:#f92672">.</span>y)
</code></pre></div><p>We&rsquo;re going to run this example without constraints</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">eq <span style="color:#f92672">=</span> []
<span style="color:#75715e"># eq.append(pCtip.dot(N.y))</span>
eq_d<span style="color:#f92672">=</span>[(system<span style="color:#f92672">.</span>derivative(item)) <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> eq]
eq_dd<span style="color:#f92672">=</span>[(system<span style="color:#f92672">.</span>derivative(item)) <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> eq_d]
</code></pre></div><p>Proceeding&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">f,ma <span style="color:#f92672">=</span> system<span style="color:#f92672">.</span>getdynamics()
</code></pre></div><pre><code>2020-12-18 11:00:32,404 - pynamics.system - INFO - getting dynamic equations
</code></pre>
<h2 id="modifications">Modifications</h2>
<p>Now here&rsquo;s where the code diverges.  Instead of just integrating the system with the values specified when the constants were created, we&rsquo;re going to split our set of constants into ones we know from calculating them, measuring them, or specifying them, and the constants we <em>don&rsquo;t know</em> because they are difficult to measure independently or only manifest in the full system.  In other words, we are separating our constants into ones we are supplying ourselves to the model, and the ones we are hoping to find using optimization</p>
<p>In this case, as an example, we specify that the damping ratio and joint stiffness are unknown:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">unknown_constants <span style="color:#f92672">=</span> [b,k]
</code></pre></div><p>From the set of system constants already defined, we can say that all the other constants are &ldquo;known&rdquo;; we use the default values specified above for these</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">known_constants <span style="color:#f92672">=</span> list(set(system<span style="color:#f92672">.</span>constant_values<span style="color:#f92672">.</span>keys())<span style="color:#f92672">-</span>set(unknown_constants))
known_constants <span style="color:#f92672">=</span> dict([(key,system<span style="color:#f92672">.</span>constant_values[key]) <span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> known_constants])
</code></pre></div><p>Also different from the original triple pendulum example: we supply the known constants earlier, when we generate our integration function.  This can help speed up integration by eliminating constants that do not change every time we integrate, making sympy&rsquo;s substitution process shorter.  Pynamics gives you the ability to specify constants when creating the state-space equations or during integration.  Note that we are only supplying the known constants at this point.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">func1,lambda1 <span style="color:#f92672">=</span> system<span style="color:#f92672">.</span>state_space_post_invert(f,ma,eq_dd,return_lambda <span style="color:#f92672">=</span> True,constants <span style="color:#f92672">=</span> known_constants)
</code></pre></div><pre><code>2020-12-18 11:00:32,827 - pynamics.system - INFO - solving a = f/m and creating function
2020-12-18 11:00:33,611 - pynamics.system - INFO - substituting constrained in Ma-f.
2020-12-18 11:00:33,842 - pynamics.system - INFO - done solving a = f/m and creating function
2020-12-18 11:00:33,842 - pynamics.system - INFO - calculating function for lambdas
</code></pre>
<p>Now we create a function to run the integration.  The input arguments (args) of this function are the unknown contants that we are trying to solve for.   We then create a dictionary (constants) that we feed into the integration step, so that each time we run this function, we can be generating the motion of a  system with different $b$ and $k$ values.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run_sim</span>(args):
    constants <span style="color:#f92672">=</span> dict([(key,value) <span style="color:#66d9ef">for</span> key,value <span style="color:#f92672">in</span> zip(unknown_constants,args)])
    states<span style="color:#f92672">=</span>pynamics<span style="color:#f92672">.</span>integration<span style="color:#f92672">.</span>integrate(func1,ini,t,rtol<span style="color:#f92672">=</span>tol,atol<span style="color:#f92672">=</span>tol,hmin<span style="color:#f92672">=</span>tol, args<span style="color:#f92672">=</span>({<span style="color:#e6db74">&#39;constants&#39;</span>:constants},))
    <span style="color:#66d9ef">return</span> states
</code></pre></div><p>Define the points that make up the motion-tracked points.  Note: your data should already be normalized for the proper scaling and orientation.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">points <span style="color:#f92672">=</span> [pNA,pAB,pBC,pCtip]
</code></pre></div><h2 id="synthesizing-data-optional">Synthesizing Data (optional)</h2>
<p>Because I don&rsquo;t have a three-link pendulum on hand, I have to create some data to which the next part of my code can be fit.  The next steps create some synthetic, noisy data to demonstrate our model-fitting procedure with.  In normal circumstances, you would be supplying input data in the form of x-y point values extracted from motion data.  In this case, we first generate some data for a given model, add some noise, and then solve with a different initial guess for those same parameters.</p>
<p>When modifying this code for your use, this is where you would want to insert data from your own experiment</p>
<p>First, run the simulation at a selected set of values for b and k</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">input_data <span style="color:#f92672">=</span> run_sim([<span style="color:#ae81ff">1.1e2</span>,<span style="color:#ae81ff">9e2</span>])
</code></pre></div><pre><code>2020-12-18 11:00:33,933 - pynamics.integration - INFO - beginning integration
2020-12-18 11:00:33,933 - pynamics.system - INFO - integration at time 0000.00
2020-12-18 11:00:34,403 - pynamics.system - INFO - integration at time 0000.47
2020-12-18 11:00:35,057 - pynamics.system - INFO - integration at time 0001.65
2020-12-18 11:00:35,772 - pynamics.system - INFO - integration at time 0006.07
2020-12-18 11:00:36,490 - pynamics.system - INFO - integration at time 0006.76
2020-12-18 11:00:37,207 - pynamics.system - INFO - integration at time 0007.14
2020-12-18 11:00:37,776 - pynamics.system - INFO - integration at time 0007.50
2020-12-18 11:00:38,292 - pynamics.system - INFO - integration at time 0007.88
2020-12-18 11:00:39,310 - pynamics.system - INFO - integration at time 0008.26
2020-12-18 11:00:40,350 - pynamics.system - INFO - integration at time 0008.63
2020-12-18 11:00:41,111 - pynamics.system - INFO - integration at time 0008.94
2020-12-18 11:00:41,838 - pynamics.system - INFO - integration at time 0009.25
2020-12-18 11:00:42,589 - pynamics.system - INFO - integration at time 0009.57
2020-12-18 11:00:43,290 - pynamics.system - INFO - integration at time 0009.88
2020-12-18 11:00:43,475 - pynamics.integration - INFO - finished integration
</code></pre>
<p>Next, create an Output to compute the motion of our markers</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">points_output <span style="color:#f92672">=</span> PointsOutput(points,system)
</code></pre></div><p>Then compute the output points.  We can plot them to see what they should look like</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">y <span style="color:#f92672">=</span> points_output<span style="color:#f92672">.</span>calc(input_data)
points_output<span style="color:#f92672">.</span>plot_time()
<span style="color:#75715e"># points_output.animate(fps = fps,movie_name = &#39;render.mp4&#39;,lw=2,marker=&#39;o&#39;,color=(1,0,0,1),linestyle=&#39;-&#39;)</span>
</code></pre></div><pre><code>2020-12-18 11:00:43,591 - pynamics.output - INFO - calculating outputs
2020-12-18 11:00:43,660 - pynamics.output - INFO - done calculating outputs
</code></pre>
<p><div class="text-center">
  <a href="output_25_1.png" target="_blank"><img src="output_25_1.png" alt="png"  class="img-fluid"/></a>
</div></p>
<p>Now create some random noise the same shape as y and add the noise to y.  We&rsquo;re doing this so that our optimization process gets some data that looks like we might expect it to if it were to come from a real sensor.  The scaling of the error can be tuned, and will affect the model we obtain as well as the model&rsquo;s accuracy.  This is a problem when working with real data too.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">r <span style="color:#f92672">=</span> numpy<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>randn(<span style="color:#f92672">*</span>(y<span style="color:#f92672">.</span>shape))<span style="color:#f92672">*.</span><span style="color:#ae81ff">01</span>
y <span style="color:#f92672">+=</span> y <span style="color:#f92672">+</span> r
</code></pre></div><p>Reshape the y vector so it is 2D, for saving to a csv file</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">y <span style="color:#f92672">=</span> y<span style="color:#f92672">.</span>reshape((len(t),<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
numpy<span style="color:#f92672">.</span>savetxt(<span style="color:#e6db74">&#34;data.csv&#34;</span>, y, delimiter<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;,&#34;</span>)
<span style="color:#75715e"># save the synthesized input data</span>
</code></pre></div><h2 id="loading-data">Loading Data</h2>
<p>Now load the input data.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">y <span style="color:#f92672">=</span> numpy<span style="color:#f92672">.</span>genfromtxt(<span style="color:#e6db74">&#39;data.csv&#39;</span>, delimiter<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;,&#39;</span>)
</code></pre></div><p>Because raw data may not correspond exactly to the simulated time series data, you will need to interpolate the data to fit the time series you are planning to run in your simulation.  Since you have predefined your time series, <code>t</code>, you can precomute the interpolated input data, <code>fyt</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">fy <span style="color:#f92672">=</span> scipy<span style="color:#f92672">.</span>interpolate<span style="color:#f92672">.</span>interp1d(t,y<span style="color:#f92672">.</span>T,fill_value<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;extrapolate&#39;</span>)
fyt <span style="color:#f92672">=</span> fy(t)<span style="color:#f92672">.</span>T
</code></pre></div><p>plot the input data.  You should see a small bit of noise in the system.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plt<span style="color:#f92672">.</span>figure()
plt<span style="color:#f92672">.</span>plot(t,fyt)
</code></pre></div><pre><code>[&lt;matplotlib.lines.Line2D at 0x23f293f8730&gt;,
 &lt;matplotlib.lines.Line2D at 0x23f293f87f0&gt;,
 &lt;matplotlib.lines.Line2D at 0x23f293f88b0&gt;,
 &lt;matplotlib.lines.Line2D at 0x23f293f8970&gt;,
 &lt;matplotlib.lines.Line2D at 0x23f293f8a30&gt;,
 &lt;matplotlib.lines.Line2D at 0x23f293f8af0&gt;,
 &lt;matplotlib.lines.Line2D at 0x23f293f8bb0&gt;,
 &lt;matplotlib.lines.Line2D at 0x23f293f8c70&gt;]
</code></pre>
<p><div class="text-center">
  <a href="output_35_1.png" target="_blank"><img src="output_35_1.png" alt="png"  class="img-fluid"/></a>
</div></p>
<p>Now define a function that calculates the sum of squared error between your guessed system and your input data.  This function is in the form required to work with <code>scipy.optimize.minimize()</code> as well as the CMA package.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calc_error</span>(args):
    states_guess <span style="color:#f92672">=</span> run_sim(args)
    y_guess <span style="color:#f92672">=</span> points_output<span style="color:#f92672">.</span>calc(states_guess)
    y_guess <span style="color:#f92672">=</span> y_guess<span style="color:#f92672">.</span>reshape((<span style="color:#ae81ff">300</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
    error <span style="color:#f92672">=</span> fyt <span style="color:#f92672">-</span> y_guess
    error <span style="color:#f92672">**=</span><span style="color:#ae81ff">2</span>
    error <span style="color:#f92672">=</span> error<span style="color:#f92672">.</span>sum()
    <span style="color:#66d9ef">return</span> error    
</code></pre></div><p>stop logging integration INFO messages for simplicity&rsquo;s sake.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">pynamics<span style="color:#f92672">.</span>system<span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>setLevel(logging<span style="color:#f92672">.</span>ERROR)
</code></pre></div><p>Create an initial guess for $b$ and $k$</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">k_guess <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1e2</span>,<span style="color:#ae81ff">1e3</span>]
</code></pre></div><p>We can try to optimize using a number of methods.  The <a href="https://docs.scipy.org/doc/scipy/reference/optimize.html">scipy.optimize</a> package&rsquo;s <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize">minimize</a> function permits one to try a variety of methods, as well as to include constraints or bounds as well as a number of other arguments.</p>
<p>In this case, we select either CMA or a scipy method based on the string in the <code>method</code> variable.</p>
<p><strong>Note:</strong> The optimization process can take a long time.  Change the method to &lsquo;CMA&rsquo; or &lsquo;BGFS&rsquo; to actually run it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">method <span style="color:#f92672">=</span> None
<span style="color:#75715e">#method = &#39;CMA&#39;</span>
<span style="color:#75715e">#method = &#39;BFGS&#39;</span>

<span style="color:#66d9ef">if</span> method <span style="color:#f92672">is</span> None:
    result <span style="color:#f92672">=</span> k_guess
<span style="color:#66d9ef">elif</span> method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;CMA&#39;</span>:
    es <span style="color:#f92672">=</span> cma<span style="color:#f92672">.</span>CMAEvolutionStrategy(k_guess, <span style="color:#ae81ff">0.5</span>)
    es<span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>disp_header()
    <span style="color:#66d9ef">while</span> <span style="color:#f92672">not</span> es<span style="color:#f92672">.</span>stop():
          X <span style="color:#f92672">=</span> es<span style="color:#f92672">.</span>ask()
          es<span style="color:#f92672">.</span>tell(X, [calc_error(x) <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> X])
          es<span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>add()
          es<span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>disp([<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
    result <span style="color:#f92672">=</span> es<span style="color:#f92672">.</span>best<span style="color:#f92672">.</span>x
<span style="color:#66d9ef">else</span>:
    sol <span style="color:#f92672">=</span> scipy<span style="color:#f92672">.</span>optimize<span style="color:#f92672">.</span>minimize(calc_error,k_guess,method <span style="color:#f92672">=</span> method)
    <span style="color:#66d9ef">print</span>(sol<span style="color:#f92672">.</span>fun)
    result <span style="color:#f92672">=</span> sol<span style="color:#f92672">.</span>x

</code></pre></div><p>Now, calculate the error of the best fit model against the input data.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">calc_error(result)
</code></pre></div><pre><code>2020-12-18 11:00:45,244 - pynamics.integration - INFO - beginning integration
2020-12-18 11:00:53,745 - pynamics.integration - INFO - finished integration
2020-12-18 11:00:53,745 - pynamics.output - INFO - calculating outputs
2020-12-18 11:00:53,826 - pynamics.output - INFO - done calculating outputs





4201.982424496521
</code></pre>
<p>Compare that to the error of the actual model against the noisy version of itself:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">calc_error(k_guess)
</code></pre></div><pre><code>2020-12-18 11:00:53,856 - pynamics.integration - INFO - beginning integration
2020-12-18 11:01:01,706 - pynamics.integration - INFO - finished integration
2020-12-18 11:01:01,708 - pynamics.output - INFO - calculating outputs
2020-12-18 11:01:01,756 - pynamics.output - INFO - done calculating outputs





4201.982424496521
</code></pre>
<p>Now plot the resulting motion and render a movie of the best-fit model.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">input_data_all2 <span style="color:#f92672">=</span> run_sim(result)
y2 <span style="color:#f92672">=</span> points_output<span style="color:#f92672">.</span>calc(input_data_all2)
points_output<span style="color:#f92672">.</span>plot_time()
points_output<span style="color:#f92672">.</span>animate(fps <span style="color:#f92672">=</span> fps,movie_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;render.mp4&#39;</span>,lw<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,marker<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;o&#39;</span>,color<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>),linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;-&#39;</span>)
</code></pre></div><pre><code>2020-12-18 11:01:01,766 - pynamics.integration - INFO - beginning integration
2020-12-18 11:01:10,278 - pynamics.integration - INFO - finished integration
2020-12-18 11:01:10,278 - pynamics.output - INFO - calculating outputs
2020-12-18 11:01:10,328 - pynamics.output - INFO - done calculating outputs
</code></pre>
<p><div class="text-center">
  <a href="output_49_1.png" target="_blank"><img src="output_49_1.png" alt="png"  class="img-fluid"/></a>
</div></p>
<p><div class="text-center">
  <a href="output_49_2.png" target="_blank"><img src="output_49_2.png" alt="png"  class="img-fluid"/></a>
</div></p>
<p>Required to animate in jupyter notebook:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> matplotlib <span style="color:#f92672">import</span> animation, rc
<span style="color:#f92672">from</span> IPython.display <span style="color:#f92672">import</span> HTML
HTML(points_output<span style="color:#f92672">.</span>anim<span style="color:#f92672">.</span>to_html5_video())
</code></pre></div><!-- raw HTML omitted -->

  </article>
</main>


    
    <footer class="blog-footer">
      <p>Copyright &copy; 2021 Daniel M. Aukes.  All rights reserved.</p>
      <p><a href="#">Back to top</a></p>
    </footer>
    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

  </body>
</html>
