<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="This site is about foldable robotics.
">
  <meta name="author" content="Daniel M. Aukes">
  <meta name="generator" content="Jekyll v4.1.1">
  <title>Solving Four-Bar Constraints | Foldable Robotics </title>

  <!--<link rel="canonical" href="https://getbootstrap.com/docs/4.5/examples/blog/">-->
  
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&display=swap" rel="stylesheet"> 
  <link href="https://fonts.googleapis.com/css2?family=Oleo+Script:wght@400;700&display=swap" rel="stylesheet"> 
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet"> 
  
  <!-- Bootstrap core CSS -->
  <link href="/assets/bootstrap-4.5.3-dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>
  
  <!-- Custom styles for this template -->
  <link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
  <!-- Custom styles for this template -->

  <link href="/assets/blog.css" rel="stylesheet">
  <link href="/assets/fontawesome-free-5.15.1-web/css/all.css" rel="stylesheet"> <!--load all styles -->
  
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/favicon/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/favicon/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/favicon/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/favicon/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/favicon/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/favicon/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/favicon/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/favicon/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/favicon/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/favicon/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
  <link rel="manifest" href="/assets/favicon/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/favicon/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
</head>
<body>
<div class="container">      
<header class="blog-header py-3">
  <div class="row flex-nowrap justify-content-between align-items-center">
    <div class="col-2 pt-1">
      
    </div>
    <div class="col-8 text-center">
      <a class="blog-header-logo text-dark" href="/">Foldable Robotics</a>
    </div>
    <div class="col-2 d-flex justify-content-end align-items-center">

    </div>
  </div>
</header>


<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <a class="navbar-brand" href="/">Home</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Modules
        </a>
        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
          
          <a class="dropdown-item" href="/modules/introduction">Introduction</a>
          
          <a class="dropdown-item" href="/modules/biomechanics">Biomechanics</a>
          
          <a class="dropdown-item" href="/modules/kinematics">Kinematics</a>
          
          <a class="dropdown-item" href="/modules/compliance">Mechanics and Compliance</a>
          
          <a class="dropdown-item" href="/modules/dynamics">Dynamics</a>
          
          <a class="dropdown-item" href="/modules/optimization">Optimization</a>
          
          <a class="dropdown-item" href="/modules/manufacturing">Prototyping & Manufacturing</a>
          
          <a class="dropdown-item" href="/modules/integration">Integration</a>
          
          <a class="dropdown-item" href="/modules/validation">Experimental Validation</a>
          
          <a class="dropdown-item" href="/modules/project">Project</a>
          
          <a class="dropdown-item" href="/modules/python">Python</a>
          
          <a class="dropdown-item" href="/modules/misc">Misc</a>
          
        </div>
      </li>
      
      <li class="nav-item">
      
      <a class="nav-link" href="/class_schedule">Class Schedule</a>
      

      </li>
      
      <li class="nav-item">
      
      <a class="nav-link" href="/my-assignments">Assignments</a>
      

      </li>
      
      <li class="nav-item">
      
      <a class="nav-link" href="/my-tutorials">Tutorials</a>
      

      </li>
      
      <li class="nav-item">
      
      <a class="nav-link" href="https://canvas.asu.edu/calendar#view_name=month" target="_blank">Canvas Calendar <i class="fas fa-external-link-alt"></i></i></a>
      

      </li>
      
      <li class="nav-item">
      
      <a class="nav-link" href="https://canvas.asu.edu/courses/71725" target="_blank">Canvas <i class="fas fa-external-link-alt"></i></i></a>
      

      </li>
      
  </div>
</nav>
<div class="row">
<div class="col-md-4 text-center">
  
  
      <h5>
        Module: <a href="/modules/kinematics">kinematics</a>
      </h5>
  
  
</div>
<div class="col-md-4 text-center">
  
  
      <h4>
        Solving Four-Bar Constraints
      </h4>
  
  
</div>
<div class="col-md-4 text-center">
  
</div>
</div>
</div><!-- /.row -->
<main role="main" class="container">
  <h1 id="solving-four-bar-constraints">Solving Four-Bar Constraints</h1>
<p>Turn on inline plotting</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span></code></pre></div>
<p>import required packages</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pynamics</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pynamics.frame <span class="im">import</span> Frame</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pynamics.variable_types <span class="im">import</span> Differentiable,Constant</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pynamics.system <span class="im">import</span> System</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#from pynamics.body import Body</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">#from pynamics.dyadic import Dyadic</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pynamics.output <span class="im">import</span> Output,PointsOutput</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">#from pynamics.particle import Particle</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pynamics.integration</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sympy</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>plt.ion()</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> math <span class="im">import</span> pi</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">#from pynamics.constraint import Constraint</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.optimize</span></code></pre></div>
<p>Create a pynamics system</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>system <span class="op">=</span> System()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>pynamics.set_system(<span class="va">__name__</span>,system)</span></code></pre></div>
<p>Declare constants</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>lA <span class="op">=</span> Constant(<span class="dv">2</span>,<span class="st">&#39;lA&#39;</span>,system)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>lB <span class="op">=</span> Constant(<span class="fl">1.5</span>,<span class="st">&#39;lB&#39;</span>,system)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>lC <span class="op">=</span> Constant(<span class="dv">1</span>,<span class="st">&#39;lC&#39;</span>,system)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>lD <span class="op">=</span> Constant(<span class="dv">1</span>,<span class="st">&#39;lD&#39;</span>,system)</span></code></pre></div>
<p>Create three differentiable state variables</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>qA,qA_d,qA_dd <span class="op">=</span> Differentiable(<span class="st">&#39;qA&#39;</span>,system)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>qB,qB_d,qB_dd <span class="op">=</span> Differentiable(<span class="st">&#39;qB&#39;</span>,system)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>qC,qC_d,qC_dd <span class="op">=</span> Differentiable(<span class="st">&#39;qC&#39;</span>,system)</span></code></pre></div>
<p>Create an initial guess for their starting positions. Note that this is not necessarily accurate given the constraint that they are supposed to be connected with given, constant length. We will use these initial values to seed the solver that will find a valid initial state</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>initialvalues <span class="op">=</span> {}</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>initialvalues[qA]<span class="op">=-</span><span class="dv">90</span><span class="op">*</span>pi<span class="op">/</span><span class="dv">180</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>initialvalues[qA_d]<span class="op">=</span><span class="dv">0</span><span class="op">*</span>pi<span class="op">/</span><span class="dv">180</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>initialvalues[qB]<span class="op">=</span><span class="dv">90</span><span class="op">*</span>pi<span class="op">/</span><span class="dv">180</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>initialvalues[qB_d]<span class="op">=</span><span class="dv">0</span><span class="op">*</span>pi<span class="op">/</span><span class="dv">180</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>initialvalues[qC]<span class="op">=</span><span class="dv">90</span><span class="op">*</span>pi<span class="op">/</span><span class="dv">180</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>initialvalues[qC_d]<span class="op">=</span><span class="dv">0</span><span class="op">*</span>pi<span class="op">/</span><span class="dv">180</span></span></code></pre></div>
<p>Retrieve state variables in the order they are stored in the system</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>statevariables <span class="op">=</span> system.get_state_variables()</span></code></pre></div>
<p>Create four frames</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> Frame(<span class="st">&#39;N&#39;</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> Frame(<span class="st">&#39;A&#39;</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>B <span class="op">=</span> Frame(<span class="st">&#39;B&#39;</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>C <span class="op">=</span> Frame(<span class="st">&#39;C&#39;</span>)</span></code></pre></div>
<p>Declare N as the Newtonian (fixed) frame</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>system.set_newtonian(N)</span></code></pre></div>
<p>Rotate A,B, and C about their local Z axes.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>A.rotate_fixed_axis_directed(N,[<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>],qA,system)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>B.rotate_fixed_axis_directed(A,[<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>],qB,system)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>C.rotate_fixed_axis_directed(B,[<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>],qC,system)</span></code></pre></div>
<p>Define vectors that will be used to solve for kinematics. Note: this can be done several possible ways as in the figure below:</p>
<figure>
<img src="../../../../sketches/four-bar-representations.png" alt="Four Bar Representations" /><figcaption aria-hidden="true">Four Bar Representations</figcaption>
</figure>
<p>Define my rigid body kinematics</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>pNA<span class="op">=</span><span class="dv">0</span><span class="op">*</span>N.x<span class="op">+</span><span class="dv">0</span><span class="op">*</span>N.y<span class="op">+</span><span class="dv">0</span><span class="op">*</span>N.z</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>pAB<span class="op">=</span>pNA<span class="op">+</span>lA<span class="op">*</span>A.x</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>pBC <span class="op">=</span> pAB <span class="op">+</span> lB<span class="op">*</span>B.x</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>pCtip <span class="op">=</span> pBC <span class="op">+</span> lC<span class="op">*</span>C.x</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>pD <span class="op">=</span> lD<span class="op">*</span>N.x</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(pNA)</span></code></pre></div>
<pre><code>pynamics.vector.Vector</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(A)</span></code></pre></div>
<pre><code>pynamics.frame.Frame</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(A.x)</span></code></pre></div>
<pre><code>pynamics.vector.Vector</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>pout <span class="op">=</span> pAB <span class="op">+</span> <span class="dv">3</span><span class="op">*</span>B.x<span class="op">-</span><span class="dv">2</span><span class="op">*</span>B.y</span></code></pre></div>
<p>Declare a list of points that will be used for plotting</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>points <span class="op">=</span> [pNA,pAB,pBC,pCtip]</span></code></pre></div>
<p>create a list of initial values ini0 in the order of the system’s state variables</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>statevariables <span class="op">=</span> system.get_state_variables()</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>ini0 <span class="op">=</span> [initialvalues[item] <span class="cf">for</span> item <span class="kw">in</span> statevariables]</span></code></pre></div>
<p>Define the closed loop kinematics of the four bar linkage.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>eq_vector <span class="op">=</span> pCtip<span class="op">-</span>pD</span></code></pre></div>
<p>Dot the vector equation with N.x and N.y to create two scalar equations. This will remove two degrees of freedom from our system.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>eq <span class="op">=</span> []</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>eq.append((eq_vector).dot(N.x))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>eq.append((eq_vector).dot(N.y))</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>eq_d<span class="op">=</span>[(system.derivative(item)) <span class="cf">for</span> item <span class="kw">in</span> eq]</span></code></pre></div>
<h2 id="solve-for-valid-initial-condition-determined-by-independent-variable">Solve for valid initial condition determined by independent variable</h2>
<p>identify independent and dependent variables</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>qi <span class="op">=</span> [qA]</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>qd <span class="op">=</span> [qB,qC]</span></code></pre></div>
<p>for dependent variables, create an initial guess</p>
<p>Create a copy of symbolic constants dictionary and add the initial value of qi to it</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>constants <span class="op">=</span> system.constant_values.copy()</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>defined <span class="op">=</span> <span class="bu">dict</span>([(item,initialvalues[item]) <span class="cf">for</span> item <span class="kw">in</span> qi])</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>constants.update(defined)</span></code></pre></div>
<p>substitute constants in equation</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>eq <span class="op">=</span> [item.subs(constants) <span class="cf">for</span> item <span class="kw">in</span> eq]</span></code></pre></div>
<p>convert to numpy array</p>
<p>sum the error</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>error <span class="op">=</span> (numpy.array(eq)<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>()</span></code></pre></div>
<p>Convert to a function that scipy can use. Sympy has a “labmdify” function that evaluates an expression, but scipy needs a slightly different format.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>f <span class="op">=</span> sympy.lambdify(qd,error)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> function(args):</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> f(<span class="op">*</span>args)</span></code></pre></div>
<p>Take the derivative of the equations to linearize with regard to the velocity variables</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>guess <span class="op">=</span> [initialvalues[item] <span class="cf">for</span> item <span class="kw">in</span> qd]</span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> scipy.optimize.minimize(function,guess)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> result.fun<span class="op">&gt;</span><span class="fl">1e-3</span>:</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span>(<span class="pp">Exception</span>(<span class="st">&quot;out of tolerance&quot;</span>))</span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>ini <span class="op">=</span> []</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> item <span class="kw">in</span> system.get_state_variables():</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> item <span class="kw">in</span> qd:</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>        ini.append(result.x[qd.index(item)])</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>        ini.append(initialvalues[item])</span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>points <span class="op">=</span> PointsOutput(points, constant_values<span class="op">=</span>system.constant_values)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>points.calc(numpy.array([ini0,ini]))</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>points.plot_time()</span></code></pre></div>
<pre><code>2021-02-15 16:31:49,166 - pynamics.output - INFO - calculating outputs
2021-02-15 16:31:49,167 - pynamics.output - INFO - done calculating outputs





&lt;AxesSubplot:&gt;</code></pre>
<figure>
<img src="output_53_2.png" alt="png" /><figcaption aria-hidden="true">png</figcaption>
</figure>
<div class="sourceCode" id="cb33"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>result.fun</span></code></pre></div>
<pre><code>5.147432205526916e-14</code></pre>
<h2 id="find-internal-jacobian">Find Internal Jacobian</h2>
<p>Now, given a valid configuration, solve for the linearized, velocity-based constraint equation. If</p>
<p><span class="math display">\[eq = \textbf{A} q_i + \textbf{B} q_d = 0\]</span> then, solving for <span class="math inline">\(q_d\)</span>, <span class="math display">\[-\textbf{B}q_d = \textbf{A}q_i\]</span> <span class="math display">\[q_d = -\textbf{B}^{-1}\textbf{A}q_i\]</span></p>
<p>Turn constraint equations into a vector</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>eq_d <span class="op">=</span> sympy.Matrix(eq_d)</span></code></pre></div>
<p>Turn qi and qd into sympy vectors</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>qi <span class="op">=</span> sympy.Matrix([qA_d])</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>qd <span class="op">=</span> sympy.Matrix([qB_d,qC_d])</span></code></pre></div>
<p>take partial derivative of constraints with respect to independent and dependent variables:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>AA <span class="op">=</span> eq_d.jacobian(qi)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>BB <span class="op">=</span> eq_d.jacobian(qd)</span></code></pre></div>
<p>Solve for internal input/output Jacobian</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>J <span class="op">=</span> <span class="op">-</span>BB.inv()<span class="op">*</span>AA</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>J</span></code></pre></div>
<pre><code>⎡                                                       (-sin(qA)⋅sin(qB)⋅sin(
⎢                                                     - ──────────────────────
⎢                                                                             
⎢                                                                             
⎢                                                                             
⎢  (-lA⋅sin(qA) - lB⋅sin(qA)⋅cos(qB) - lB⋅sin(qB)⋅cos(qA) + lC⋅(sin(qA)⋅sin(qB
⎢- ───────────────────────────────────────────────────────────────────────────
⎢                                                                             
⎣                                                                             

qC) + sin(qA)⋅cos(qB)⋅cos(qC) + sin(qB)⋅cos(qA)⋅cos(qC) + sin(qC)⋅cos(qA)⋅cos(
──────────────────────────────────────────────────────────────────────────────
                                                     2        2               
                                               lB⋅sin (qA)⋅sin (qB)⋅sin(qC) + 
                                                                              
) - cos(qA)⋅cos(qB))⋅sin(qC) + lC⋅(-sin(qA)⋅cos(qB) - sin(qB)⋅cos(qA))⋅cos(qC)
──────────────────────────────────────────────────────────────────────────────
                       2        2                        2                2   
              lB⋅lC⋅sin (qA)⋅sin (qB)⋅sin(qC) + lB⋅lC⋅sin (qA)⋅sin(qC)⋅cos (qB

qB))⋅(lA⋅cos(qA) - lB⋅sin(qA)⋅sin(qB) + lB⋅cos(qA)⋅cos(qB) + lC⋅(-sin(qA)⋅sin(
──────────────────────────────────────────────────────────────────────────────
      2                2             2                2                     2 
lB⋅sin (qA)⋅sin(qC)⋅cos (qB) + lB⋅sin (qB)⋅sin(qC)⋅cos (qA) + lB⋅sin(qC)⋅cos (
                                                                              
)⋅(lB⋅sin(qA)⋅sin(qB) - lB⋅cos(qA)⋅cos(qB) + lC⋅sin(qA)⋅sin(qB)⋅cos(qC) + lC⋅s
──────────────────────────────────────────────────────────────────────────────
             2                2                        2        2             
) + lB⋅lC⋅sin (qB)⋅sin(qC)⋅cos (qA) + lB⋅lC⋅sin(qC)⋅cos (qA)⋅cos (qB)         

qB) + cos(qA)⋅cos(qB))⋅cos(qC) + lC⋅(-sin(qA)⋅cos(qB) - sin(qB)⋅cos(qA))⋅sin(q
──────────────────────────────────────────────────────────────────────────────
       2                                                                      
qA)⋅cos (qB)                                                                  
                                                                              
in(qA)⋅sin(qC)⋅cos(qB) + lC⋅sin(qB)⋅sin(qC)⋅cos(qA) - lC⋅cos(qA)⋅cos(qB)⋅cos(q
──────────────────────────────────────────────────────────────────────────────
                                                                              
                                                                              

C))   (-sin(qA)⋅sin(qB)⋅cos(qC) - sin(qA)⋅sin(qC)⋅cos(qB) - sin(qB)⋅sin(qC)⋅co
─── - ────────────────────────────────────────────────────────────────────────
                                                                              
                                                                           lB⋅
                                                                              
C))   (lA⋅cos(qA) - lB⋅sin(qA)⋅sin(qB) + lB⋅cos(qA)⋅cos(qB) + lC⋅(-sin(qA)⋅sin
─── - ────────────────────────────────────────────────────────────────────────
                                                                              
                                                                              

s(qA) + cos(qA)⋅cos(qB)⋅cos(qC))⋅(-lA⋅sin(qA) - lB⋅sin(qA)⋅cos(qB) - lB⋅sin(qB
──────────────────────────────────────────────────────────────────────────────
   2        2                     2                2             2            
sin (qA)⋅sin (qB)⋅sin(qC) + lB⋅sin (qA)⋅sin(qC)⋅cos (qB) + lB⋅sin (qB)⋅sin(qC)
                                                                              
(qB) + cos(qA)⋅cos(qB))⋅cos(qC) + lC⋅(-sin(qA)⋅cos(qB) - sin(qB)⋅cos(qA))⋅sin(
──────────────────────────────────────────────────────────────────────────────
                           2        2                        2                
                  lB⋅lC⋅sin (qA)⋅sin (qB)⋅sin(qC) + lB⋅lC⋅sin (qA)⋅sin(qC)⋅cos

)⋅cos(qA) + lC⋅(sin(qA)⋅sin(qB) - cos(qA)⋅cos(qB))⋅sin(qC) + lC⋅(-sin(qA)⋅cos(
──────────────────────────────────────────────────────────────────────────────
    2                     2        2                                          
⋅cos (qA) + lB⋅sin(qC)⋅cos (qA)⋅cos (qB)                                      
                                                                              
qC))⋅(-lB⋅sin(qA)⋅cos(qB) - lB⋅sin(qB)⋅cos(qA) + lC⋅sin(qA)⋅sin(qB)⋅sin(qC) - 
──────────────────────────────────────────────────────────────────────────────
2                2                2                        2        2         
 (qB) + lB⋅lC⋅sin (qB)⋅sin(qC)⋅cos (qA) + lB⋅lC⋅sin(qC)⋅cos (qA)⋅cos (qB)     

qB) - sin(qB)⋅cos(qA))⋅cos(qC))                                               
───────────────────────────────                                               
                                                                              
                                                                              
                                                                              
lC⋅sin(qA)⋅cos(qB)⋅cos(qC) - lC⋅sin(qB)⋅cos(qA)⋅cos(qC) - lC⋅sin(qC)⋅cos(qA)⋅c
──────────────────────────────────────────────────────────────────────────────
                                                                              
                                                                              

       ⎤
       ⎥
       ⎥
       ⎥
       ⎥
os(qB))⎥
───────⎥
       ⎥
       ⎦</code></pre>
<p>That expression is quite long. We can use the simplify function provided by sympy to shorten the expression:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>J.simplify()</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>J</span></code></pre></div>
<pre><code>⎡ ⎛lA⋅sin(qB)                  ⎞  ⎤
⎢-⎜────────── + lA⋅cos(qB) + lB⎟  ⎥
⎢ ⎝ tan(qC)                    ⎠  ⎥
⎢──────────────────────────────── ⎥
⎢               lB                ⎥
⎢                                 ⎥
⎢lA⋅(lB⋅sin(qB) + lC⋅sin(qB + qC))⎥
⎢─────────────────────────────────⎥
⎣          lB⋅lC⋅sin(qC)          ⎦</code></pre>
<p>Solving for the dependent variables <span class="math inline">\(q_d\)</span>:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>qd2 <span class="op">=</span> J<span class="op">*</span>qi</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>qd2</span></code></pre></div>
<pre><code>⎡      ⎛lA⋅sin(qB)                  ⎞  ⎤
⎢-qA_d⋅⎜────────── + lA⋅cos(qB) + lB⎟  ⎥
⎢      ⎝ tan(qC)                    ⎠  ⎥
⎢───────────────────────────────────── ⎥
⎢                  lB                  ⎥
⎢                                      ⎥
⎢lA⋅qA_d⋅(lB⋅sin(qB) + lC⋅sin(qB + qC))⎥
⎢──────────────────────────────────────⎥
⎣            lB⋅lC⋅sin(qC)             ⎦</code></pre>
<p>Now we can create a substitution dictionary to replace all occurrances of <span class="math inline">\(\dot{q}_b\)</span> and <span class="math inline">\(\dot{q}_c\)</span></p>
<div class="sourceCode" id="cb44"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>subs <span class="op">=</span> <span class="bu">dict</span>([(ii,jj) <span class="cf">for</span> ii,jj <span class="kw">in</span> <span class="bu">zip</span>(qd,qd2)])</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>subs</span></code></pre></div>
<pre><code>⎧            ⎛lA⋅sin(qB)                  ⎞                                   
⎪      -qA_d⋅⎜────────── + lA⋅cos(qB) + lB⎟                                   
⎨            ⎝ tan(qC)                    ⎠         lA⋅qA_d⋅(lB⋅sin(qB) + lC⋅s
⎪qB_d: ─────────────────────────────────────, qC_d: ──────────────────────────
⎩                        lB                                     lB⋅lC⋅sin(qC) 

            ⎫
            ⎪
in(qB + qC))⎬
────────────⎪
            ⎭</code></pre>
<p>Now pick an end-effector</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>pout</span></code></pre></div>
<pre><code>lA*A.x + 3*B.x - 2*B.y</code></pre>
<div class="sourceCode" id="cb48"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>vout <span class="op">=</span> pout.time_derivative()</span></code></pre></div>
<div class="sourceCode" id="cb49"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>vout</span></code></pre></div>
<pre><code>lA*qA_d*A.y + B.x*(2*qA_d + 2*qB_d) + B.y*(3*qA_d + 3*qB_d)</code></pre>
<div class="sourceCode" id="cb51"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>vout <span class="op">=</span> vout.subs(subs)</span></code></pre></div>
<div class="sourceCode" id="cb52"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>vout</span></code></pre></div>
<pre><code>lA*qA_d*A.y + B.x*(2*qA_d - 2*qA_d*(lA*sin(qB)/tan(qC) + lA*cos(qB) + lB)/lB) + B.y*(3*qA_d - 3*qA_d*(lA*sin(qB)/tan(qC) + lA*cos(qB) + lB)/lB)</code></pre>
<div class="sourceCode" id="cb54"><pre class="sourceCode python"><code class="sourceCode python"></code></pre></div>
<div class="sourceCode" id="cb55"><pre class="sourceCode python"><code class="sourceCode python"></code></pre></div>

</main><!-- /.container -->
<footer class="blog-footer">
  

  <p>Copyright &copy; 2020 Daniel M. Aukes.  All rights reserved.</p>
  <p><a href="#">Back to top</a></p>
</footer>

<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</body>
</html>
