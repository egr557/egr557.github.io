<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <title>
Solving Four-Bar Constraints | Foldable Robotics
</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">

<style>
  .bd-placeholder-img {
    font-size: 1.125rem;
    text-anchor: middle;
    -webkit-user-select: none;
    -moz-user-select: none;
    user-select: none;
  }

  @media (min-width: 768px) {
    .bd-placeholder-img-lg {
      font-size: 3.5rem;
    }
  }
</style>

<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Oleo+Script:wght@400;700&display=swap" rel="stylesheet"> 
<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet"> 


<link href="/css/blog.css" rel="stylesheet">
<link href="/css/features.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">


    <script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$','$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };

  window.addEventListener('load', (event) => {
      document.querySelectorAll("mjx-container").forEach(function(x){
        x.parentElement.classList += 'has-jax'})
    });

</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <link rel="stylesheet" type="text/css" href="/hugo-cite.css" />

    <link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/favicon/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
<link rel="manifest" href="/favicon/manifest.json">


  </head>
  <body>

    <div class="container">

      <header class="blog-header py-3">
  <div class="row flex-nowrap justify-content-between align-items-center">
    <div class="col-2 pt-1">
    </div>
    <div class="col-8 text-center">
      <a class="blog-header-logo text-dark" href="/">Foldable Robotics</a>
    </div>
    <div class="col-2 d-flex justify-content-end align-items-center">
    </div>
  </div>
</header>


      <nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">Home</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        
        
        
        
        
      
        <li class="nav-item">
          <a class="nav-link" href="/assignments/">Assignments</a>
        </li>
        
        
        
        
        
      
        <li class="nav-item">
          <a class="nav-link" href="/calendar/">Course Calendar</a>
        </li>
        
        
        
        
        
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="/course-documents/" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Course Documents
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
            
            <li><a class="dropdown-item" href="/course-documents/software-list/">Software List</a></li>
            
            <li><a class="dropdown-item" href="/course-documents/submission-best-practices/">Submission Best Practices</a></li>
            
            <li><a class="dropdown-item" href="/course-documents/suggested-materials-list/">Suggested Materials List</a></li>
            
            <li><a class="dropdown-item" href="/course-documents/syllabus-web/">Syllabus for Foldable Robotics</a></li>
            
          </ul>
        </li>
        
        
        
        
        
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="/modules/" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Course Topics
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
            
            <li><a class="dropdown-item" href="/modules/biomechanics/">Biomechanics &amp; Bio-inspiration</a></li>
            
            <li><a class="dropdown-item" href="/modules/dynamics/">Dynamics</a></li>
            
            <li><a class="dropdown-item" href="/modules/validation/">Experimental Validation</a></li>
            
            <li><a class="dropdown-item" href="/modules/integration/">Integration</a></li>
            
            <li><a class="dropdown-item" href="/modules/introduction/">Introduction</a></li>
            
            <li><a class="dropdown-item" href="/modules/kinematics/">Kinematics</a></li>
            
            <li><a class="dropdown-item" href="/modules/compliance/">Mechanics and Compliance</a></li>
            
            <li><a class="dropdown-item" href="/modules/misc/">Misc</a></li>
            
            <li><a class="dropdown-item" href="/modules/optimization/">Optimization</a></li>
            
            <li><a class="dropdown-item" href="/modules/project/">Project</a></li>
            
            <li><a class="dropdown-item" href="/modules/manufacturing/">Prototyping &amp; Manufacturing</a></li>
            
            <li><a class="dropdown-item" href="/modules/python/">Python</a></li>
            
          </ul>
        </li>
        
        
        
        
        
      
        <li class="nav-item">
          <a class="nav-link" href="/lectures/">Lectures</a>
        </li>
        
        
        
        
        <li class="nav-item">
          
          <a class="nav-link" href="https://canvas.asu.edu/"target="_blank">Canvas <i class="bi bi-link"></i></a> 
        </li>
        
        
      </ul>
      <span class="navbar-text">
        Making better Foldable Robots
      </span>

    </div>
  </div>
</nav>

    </div>

    
<main class="container">
  <article>
  <h1>Default Single Page: Solving Four-Bar Constraints</h1>
  <h1 id="solving-four-bar-constraints">Solving Four-Bar Constraints</h1>
<p>Turn on inline plotting</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">%</span>matplotlib inline
</code></pre></div><p>import required packages</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> pynamics
<span style="color:#f92672">from</span> pynamics.frame <span style="color:#f92672">import</span> Frame
<span style="color:#f92672">from</span> pynamics.variable_types <span style="color:#f92672">import</span> Differentiable,Constant
<span style="color:#f92672">from</span> pynamics.system <span style="color:#f92672">import</span> System
<span style="color:#75715e">#from pynamics.body import Body</span>
<span style="color:#75715e">#from pynamics.dyadic import Dyadic</span>
<span style="color:#f92672">from</span> pynamics.output <span style="color:#f92672">import</span> Output,PointsOutput
<span style="color:#75715e">#from pynamics.particle import Particle</span>
<span style="color:#f92672">import</span> pynamics.integration
<span style="color:#f92672">import</span> sympy
<span style="color:#f92672">import</span> numpy
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
plt<span style="color:#f92672">.</span>ion()
<span style="color:#f92672">from</span> math <span style="color:#f92672">import</span> pi
<span style="color:#75715e">#from pynamics.constraint import Constraint</span>
<span style="color:#f92672">import</span> scipy.optimize

</code></pre></div><p>Create a pynamics system</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">system <span style="color:#f92672">=</span> System()
pynamics<span style="color:#f92672">.</span>set_system(__name__,system)
</code></pre></div><p>Declare constants</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">lA <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">2</span>,<span style="color:#e6db74">&#39;lA&#39;</span>,system)
lB <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1.5</span>,<span style="color:#e6db74">&#39;lB&#39;</span>,system)
lC <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;lC&#39;</span>,system)
lD <span style="color:#f92672">=</span> Constant(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;lD&#39;</span>,system)
</code></pre></div><p>Create three differentiable state variables</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">qA,qA_d,qA_dd <span style="color:#f92672">=</span> Differentiable(<span style="color:#e6db74">&#39;qA&#39;</span>,system)
qB,qB_d,qB_dd <span style="color:#f92672">=</span> Differentiable(<span style="color:#e6db74">&#39;qB&#39;</span>,system)
qC,qC_d,qC_dd <span style="color:#f92672">=</span> Differentiable(<span style="color:#e6db74">&#39;qC&#39;</span>,system)
</code></pre></div><p>Create an initial guess for their starting positions.  Note that this is not necessarily accurate given the constraint that they are supposed to be connected with given, constant length.  We will use these initial values to seed the solver that will find a valid initial state</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">initialvalues <span style="color:#f92672">=</span> {}
initialvalues[qA]<span style="color:#f92672">=-</span><span style="color:#ae81ff">90</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">180</span>
initialvalues[qA_d]<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">180</span>
initialvalues[qB]<span style="color:#f92672">=</span><span style="color:#ae81ff">90</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">180</span>
initialvalues[qB_d]<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">180</span>
initialvalues[qC]<span style="color:#f92672">=</span><span style="color:#ae81ff">90</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">180</span>
initialvalues[qC_d]<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">180</span>
</code></pre></div><p>Retrieve state variables in the order they are stored in the system</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">statevariables <span style="color:#f92672">=</span> system<span style="color:#f92672">.</span>get_state_variables()
</code></pre></div><p>Create four frames</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">N <span style="color:#f92672">=</span> Frame(<span style="color:#e6db74">&#39;N&#39;</span>)
A <span style="color:#f92672">=</span> Frame(<span style="color:#e6db74">&#39;A&#39;</span>)
B <span style="color:#f92672">=</span> Frame(<span style="color:#e6db74">&#39;B&#39;</span>)
C <span style="color:#f92672">=</span> Frame(<span style="color:#e6db74">&#39;C&#39;</span>)
</code></pre></div><p>Declare N as the Newtonian (fixed) frame</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">system<span style="color:#f92672">.</span>set_newtonian(N)
</code></pre></div><p>Rotate A,B, and C about their local Z axes.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">A<span style="color:#f92672">.</span>rotate_fixed_axis_directed(N,[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>],qA,system)
B<span style="color:#f92672">.</span>rotate_fixed_axis_directed(A,[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>],qB,system)
C<span style="color:#f92672">.</span>rotate_fixed_axis_directed(B,[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>],qC,system)
</code></pre></div><p>Define vectors that will be used to solve for kinematics.  Note: this can be done several possible ways as in the figure below:</p>
<p><div class="text-center">
  <a href="../../../../sketches/four-bar-representations.png" target="_blank"><img src="../../../../sketches/four-bar-representations.png" alt="Four Bar Representations"  class="img-fluid"/></a>
</div></p>
<p>Define my rigid body kinematics</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">pNA<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">*</span>N<span style="color:#f92672">.</span>x<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span><span style="color:#f92672">*</span>N<span style="color:#f92672">.</span>y<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span><span style="color:#f92672">*</span>N<span style="color:#f92672">.</span>z

pAB<span style="color:#f92672">=</span>pNA<span style="color:#f92672">+</span>lA<span style="color:#f92672">*</span>A<span style="color:#f92672">.</span>x

pBC <span style="color:#f92672">=</span> pAB <span style="color:#f92672">+</span> lB<span style="color:#f92672">*</span>B<span style="color:#f92672">.</span>x

pCtip <span style="color:#f92672">=</span> pBC <span style="color:#f92672">+</span> lC<span style="color:#f92672">*</span>C<span style="color:#f92672">.</span>x

pD <span style="color:#f92672">=</span> lD<span style="color:#f92672">*</span>N<span style="color:#f92672">.</span>x
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">type(pNA)
</code></pre></div><pre><code>pynamics.vector.Vector
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">type(A)
</code></pre></div><pre><code>pynamics.frame.Frame
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">type(A<span style="color:#f92672">.</span>x)
</code></pre></div><pre><code>pynamics.vector.Vector
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">pout <span style="color:#f92672">=</span> pAB <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">*</span>B<span style="color:#f92672">.</span>x<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>B<span style="color:#f92672">.</span>y
</code></pre></div><p>Declare a list of points that will be used for plotting</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">points <span style="color:#f92672">=</span> [pNA,pAB,pBC,pCtip]
</code></pre></div><p>create a list of initial values ini0 in the order of the system&rsquo;s state variables</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">statevariables <span style="color:#f92672">=</span> system<span style="color:#f92672">.</span>get_state_variables()
ini0 <span style="color:#f92672">=</span> [initialvalues[item] <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> statevariables]
</code></pre></div><p>Define the closed loop kinematics of the four bar linkage.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">eq_vector <span style="color:#f92672">=</span> pCtip<span style="color:#f92672">-</span>pD
</code></pre></div><p>Dot the vector equation with N.x and N.y to create two scalar equations.  This will remove two degrees of freedom from our system.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">eq <span style="color:#f92672">=</span> []
eq<span style="color:#f92672">.</span>append((eq_vector)<span style="color:#f92672">.</span>dot(N<span style="color:#f92672">.</span>x))
eq<span style="color:#f92672">.</span>append((eq_vector)<span style="color:#f92672">.</span>dot(N<span style="color:#f92672">.</span>y))
eq_d<span style="color:#f92672">=</span>[(system<span style="color:#f92672">.</span>derivative(item)) <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> eq]
</code></pre></div><h2 id="solve-for-valid-initial-condition-determined-by-independent-variable">Solve for valid initial condition determined by independent variable</h2>
<p>identify independent and dependent variables</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">qi <span style="color:#f92672">=</span> [qA]
qd <span style="color:#f92672">=</span> [qB,qC]
</code></pre></div><p>for dependent variables, create an initial guess</p>
<p>Create a copy of symbolic constants dictionary and add the initial value of qi to it</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">constants <span style="color:#f92672">=</span> system<span style="color:#f92672">.</span>constant_values<span style="color:#f92672">.</span>copy()
defined <span style="color:#f92672">=</span> dict([(item,initialvalues[item]) <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> qi])
constants<span style="color:#f92672">.</span>update(defined)
</code></pre></div><p>substitute constants in equation</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">eq <span style="color:#f92672">=</span> [item<span style="color:#f92672">.</span>subs(constants) <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> eq]
</code></pre></div><p>convert to numpy array</p>
<p>sum the error</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">error <span style="color:#f92672">=</span> (numpy<span style="color:#f92672">.</span>array(eq)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">.</span>sum()
</code></pre></div><p>Convert to a function that scipy can use.  Sympy has a &ldquo;labmdify&rdquo; function that evaluates an expression, but scipy needs a slightly different format.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">f <span style="color:#f92672">=</span> sympy<span style="color:#f92672">.</span>lambdify(qd,error)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">function</span>(args):
    <span style="color:#66d9ef">return</span> f(<span style="color:#f92672">*</span>args)
</code></pre></div><p>Take the derivative of the equations to linearize with regard to the velocity variables</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">guess <span style="color:#f92672">=</span> [initialvalues[item] <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> qd]
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">result <span style="color:#f92672">=</span> scipy<span style="color:#f92672">.</span>optimize<span style="color:#f92672">.</span>minimize(function,guess)
<span style="color:#66d9ef">if</span> result<span style="color:#f92672">.</span>fun<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">1e-3</span>:
    <span style="color:#66d9ef">raise</span>(<span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#34;out of tolerance&#34;</span>))
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ini <span style="color:#f92672">=</span> []
<span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> system<span style="color:#f92672">.</span>get_state_variables():
    <span style="color:#66d9ef">if</span> item <span style="color:#f92672">in</span> qd:
        ini<span style="color:#f92672">.</span>append(result<span style="color:#f92672">.</span>x[qd<span style="color:#f92672">.</span>index(item)])
    <span style="color:#66d9ef">else</span>:
        ini<span style="color:#f92672">.</span>append(initialvalues[item])
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">points <span style="color:#f92672">=</span> PointsOutput(points, constant_values<span style="color:#f92672">=</span>system<span style="color:#f92672">.</span>constant_values)
points<span style="color:#f92672">.</span>calc(numpy<span style="color:#f92672">.</span>array([ini0,ini]))
points<span style="color:#f92672">.</span>plot_time()
</code></pre></div><pre><code>2021-02-15 16:31:49,166 - pynamics.output - INFO - calculating outputs
2021-02-15 16:31:49,167 - pynamics.output - INFO - done calculating outputs





&lt;AxesSubplot:&gt;
</code></pre>
<p><div class="text-center">
  <a href="output_53_2.png" target="_blank"><img src="output_53_2.png" alt="png"  class="img-fluid"/></a>
</div></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">result<span style="color:#f92672">.</span>fun
</code></pre></div><pre><code>5.147432205526916e-14
</code></pre>
<h2 id="find-internal-jacobian">Find Internal Jacobian</h2>
<p>Now, given a valid configuration, solve for the linearized, velocity-based constraint equation.  If</p>
<p>$$eq = \textbf{A} q_i + \textbf{B} q_d = 0$$
then, solving for $q_d$, 
$$-\textbf{B}q_d = \textbf{A}q_i$$
$$q_d = -\textbf{B}^{-1}\textbf{A}q_i$$</p>
<p>Turn constraint equations into a vector</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">eq_d <span style="color:#f92672">=</span> sympy<span style="color:#f92672">.</span>Matrix(eq_d)
</code></pre></div><p>Turn qi and qd into sympy vectors</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">qi <span style="color:#f92672">=</span> sympy<span style="color:#f92672">.</span>Matrix([qA_d])
qd <span style="color:#f92672">=</span> sympy<span style="color:#f92672">.</span>Matrix([qB_d,qC_d])
</code></pre></div><p>take partial derivative of constraints with respect to independent and dependent variables:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">AA <span style="color:#f92672">=</span> eq_d<span style="color:#f92672">.</span>jacobian(qi)
BB <span style="color:#f92672">=</span> eq_d<span style="color:#f92672">.</span>jacobian(qd)
</code></pre></div><p>Solve for internal input/output Jacobian</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">J <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>BB<span style="color:#f92672">.</span>inv()<span style="color:#f92672">*</span>AA
J
</code></pre></div><pre><code>⎡                                                       (-sin(qA)⋅sin(qB)⋅sin(
⎢                                                     - ──────────────────────
⎢                                                                             
⎢                                                                             
⎢                                                                             
⎢  (-lA⋅sin(qA) - lB⋅sin(qA)⋅cos(qB) - lB⋅sin(qB)⋅cos(qA) + lC⋅(sin(qA)⋅sin(qB
⎢- ───────────────────────────────────────────────────────────────────────────
⎢                                                                             
⎣                                                                             

qC) + sin(qA)⋅cos(qB)⋅cos(qC) + sin(qB)⋅cos(qA)⋅cos(qC) + sin(qC)⋅cos(qA)⋅cos(
──────────────────────────────────────────────────────────────────────────────
                                                     2        2               
                                               lB⋅sin (qA)⋅sin (qB)⋅sin(qC) + 
                                                                              
) - cos(qA)⋅cos(qB))⋅sin(qC) + lC⋅(-sin(qA)⋅cos(qB) - sin(qB)⋅cos(qA))⋅cos(qC)
──────────────────────────────────────────────────────────────────────────────
                       2        2                        2                2   
              lB⋅lC⋅sin (qA)⋅sin (qB)⋅sin(qC) + lB⋅lC⋅sin (qA)⋅sin(qC)⋅cos (qB

qB))⋅(lA⋅cos(qA) - lB⋅sin(qA)⋅sin(qB) + lB⋅cos(qA)⋅cos(qB) + lC⋅(-sin(qA)⋅sin(
──────────────────────────────────────────────────────────────────────────────
      2                2             2                2                     2 
lB⋅sin (qA)⋅sin(qC)⋅cos (qB) + lB⋅sin (qB)⋅sin(qC)⋅cos (qA) + lB⋅sin(qC)⋅cos (
                                                                              
)⋅(lB⋅sin(qA)⋅sin(qB) - lB⋅cos(qA)⋅cos(qB) + lC⋅sin(qA)⋅sin(qB)⋅cos(qC) + lC⋅s
──────────────────────────────────────────────────────────────────────────────
             2                2                        2        2             
) + lB⋅lC⋅sin (qB)⋅sin(qC)⋅cos (qA) + lB⋅lC⋅sin(qC)⋅cos (qA)⋅cos (qB)         

qB) + cos(qA)⋅cos(qB))⋅cos(qC) + lC⋅(-sin(qA)⋅cos(qB) - sin(qB)⋅cos(qA))⋅sin(q
──────────────────────────────────────────────────────────────────────────────
       2                                                                      
qA)⋅cos (qB)                                                                  
                                                                              
in(qA)⋅sin(qC)⋅cos(qB) + lC⋅sin(qB)⋅sin(qC)⋅cos(qA) - lC⋅cos(qA)⋅cos(qB)⋅cos(q
──────────────────────────────────────────────────────────────────────────────
                                                                              
                                                                              

C))   (-sin(qA)⋅sin(qB)⋅cos(qC) - sin(qA)⋅sin(qC)⋅cos(qB) - sin(qB)⋅sin(qC)⋅co
─── - ────────────────────────────────────────────────────────────────────────
                                                                              
                                                                           lB⋅
                                                                              
C))   (lA⋅cos(qA) - lB⋅sin(qA)⋅sin(qB) + lB⋅cos(qA)⋅cos(qB) + lC⋅(-sin(qA)⋅sin
─── - ────────────────────────────────────────────────────────────────────────
                                                                              
                                                                              

s(qA) + cos(qA)⋅cos(qB)⋅cos(qC))⋅(-lA⋅sin(qA) - lB⋅sin(qA)⋅cos(qB) - lB⋅sin(qB
──────────────────────────────────────────────────────────────────────────────
   2        2                     2                2             2            
sin (qA)⋅sin (qB)⋅sin(qC) + lB⋅sin (qA)⋅sin(qC)⋅cos (qB) + lB⋅sin (qB)⋅sin(qC)
                                                                              
(qB) + cos(qA)⋅cos(qB))⋅cos(qC) + lC⋅(-sin(qA)⋅cos(qB) - sin(qB)⋅cos(qA))⋅sin(
──────────────────────────────────────────────────────────────────────────────
                           2        2                        2                
                  lB⋅lC⋅sin (qA)⋅sin (qB)⋅sin(qC) + lB⋅lC⋅sin (qA)⋅sin(qC)⋅cos

)⋅cos(qA) + lC⋅(sin(qA)⋅sin(qB) - cos(qA)⋅cos(qB))⋅sin(qC) + lC⋅(-sin(qA)⋅cos(
──────────────────────────────────────────────────────────────────────────────
    2                     2        2                                          
⋅cos (qA) + lB⋅sin(qC)⋅cos (qA)⋅cos (qB)                                      
                                                                              
qC))⋅(-lB⋅sin(qA)⋅cos(qB) - lB⋅sin(qB)⋅cos(qA) + lC⋅sin(qA)⋅sin(qB)⋅sin(qC) - 
──────────────────────────────────────────────────────────────────────────────
2                2                2                        2        2         
 (qB) + lB⋅lC⋅sin (qB)⋅sin(qC)⋅cos (qA) + lB⋅lC⋅sin(qC)⋅cos (qA)⋅cos (qB)     

qB) - sin(qB)⋅cos(qA))⋅cos(qC))                                               
───────────────────────────────                                               
                                                                              
                                                                              
                                                                              
lC⋅sin(qA)⋅cos(qB)⋅cos(qC) - lC⋅sin(qB)⋅cos(qA)⋅cos(qC) - lC⋅sin(qC)⋅cos(qA)⋅c
──────────────────────────────────────────────────────────────────────────────
                                                                              
                                                                              

       ⎤
       ⎥
       ⎥
       ⎥
       ⎥
os(qB))⎥
───────⎥
       ⎥
       ⎦
</code></pre>
<p>That expression is quite long.  We can use the simplify function provided by sympy to shorten the expression:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">J<span style="color:#f92672">.</span>simplify()
J
</code></pre></div><pre><code>⎡ ⎛lA⋅sin(qB)                  ⎞  ⎤
⎢-⎜────────── + lA⋅cos(qB) + lB⎟  ⎥
⎢ ⎝ tan(qC)                    ⎠  ⎥
⎢──────────────────────────────── ⎥
⎢               lB                ⎥
⎢                                 ⎥
⎢lA⋅(lB⋅sin(qB) + lC⋅sin(qB + qC))⎥
⎢─────────────────────────────────⎥
⎣          lB⋅lC⋅sin(qC)          ⎦
</code></pre>
<p>Solving for the dependent variables $q_d$:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">qd2 <span style="color:#f92672">=</span> J<span style="color:#f92672">*</span>qi
qd2
</code></pre></div><pre><code>⎡      ⎛lA⋅sin(qB)                  ⎞  ⎤
⎢-qA_d⋅⎜────────── + lA⋅cos(qB) + lB⎟  ⎥
⎢      ⎝ tan(qC)                    ⎠  ⎥
⎢───────────────────────────────────── ⎥
⎢                  lB                  ⎥
⎢                                      ⎥
⎢lA⋅qA_d⋅(lB⋅sin(qB) + lC⋅sin(qB + qC))⎥
⎢──────────────────────────────────────⎥
⎣            lB⋅lC⋅sin(qC)             ⎦
</code></pre>
<p>Now we can create a substitution dictionary to replace all occurrances of $\dot{q}_b$ and  $\dot{q}_c$</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">subs <span style="color:#f92672">=</span> dict([(ii,jj) <span style="color:#66d9ef">for</span> ii,jj <span style="color:#f92672">in</span> zip(qd,qd2)])
subs
</code></pre></div><pre><code>⎧            ⎛lA⋅sin(qB)                  ⎞                                   
⎪      -qA_d⋅⎜────────── + lA⋅cos(qB) + lB⎟                                   
⎨            ⎝ tan(qC)                    ⎠         lA⋅qA_d⋅(lB⋅sin(qB) + lC⋅s
⎪qB_d: ─────────────────────────────────────, qC_d: ──────────────────────────
⎩                        lB                                     lB⋅lC⋅sin(qC) 

            ⎫
            ⎪
in(qB + qC))⎬
────────────⎪
            ⎭
</code></pre>
<p>Now pick an end-effector</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">pout
</code></pre></div><pre><code>lA*A.x + 3*B.x - 2*B.y
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">vout <span style="color:#f92672">=</span> pout<span style="color:#f92672">.</span>time_derivative()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">vout
</code></pre></div><pre><code>lA*qA_d*A.y + B.x*(2*qA_d + 2*qB_d) + B.y*(3*qA_d + 3*qB_d)
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">vout <span style="color:#f92672">=</span> vout<span style="color:#f92672">.</span>subs(subs)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">vout
</code></pre></div><pre><code>lA*qA_d*A.y + B.x*(2*qA_d - 2*qA_d*(lA*sin(qB)/tan(qC) + lA*cos(qB) + lB)/lB) + B.y*(3*qA_d - 3*qA_d*(lA*sin(qB)/tan(qC) + lA*cos(qB) + lB)/lB)
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
</code></pre></div>
  </article>
</main>


    
    <footer class="blog-footer">
      <p>Copyright &copy; 2021 Daniel M. Aukes.  All rights reserved.</p>
      <p><a href="#">Back to top</a></p>
    </footer>
    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

  </body>
</html>
